
FROM	amazonlinux:latest

LABEL   name="sre ladon prometheus image" \
		maintainer="traiana sre team <sre@traiana.com>" \
		vendor="traiana-sre" \
		build-date="20180229"

ARG     DOCK_BUILD_ARG_SRC_APP_CONFIG_FILE
ARG     DOCK_BUILD_ARG_DST_APP_CONFIG_FILE
ARG     DOCK_BUILD_ARG_WEB_LISTEN_PORT
ARG     DOCK_BUILD_ARG_WEB_USER_ASSETS
ARG     DOCK_BUILD_ARG_STORAGE_TSDB_PATH
ARG     DOCK_BUILD_ARG_QUERY_LOOKBACK_DELTA
ARG     DOCK_BUILD_ARG_QUERY_MAX_CONCURRENCY
ARG     DOCK_BUILD_ARG_QUERY_TIMEOUT
ARG     DOCK_BUILD_ARG_STORAGE_TSDB_RETENTION
ARG     DOCK_BUILD_ARG_LOG_LEVEL
ARG     AUTO_CONF_ENV
ARG     AUTO_CONF_BAIKO_TOKEN

ENV     KUBE_LATEST_VERSION="v1.10.0"
ENV     SRC_APP_CONFIG_FILE=${DOCK_BUILD_ARG_SRC_APP_CONFIG_FILE} DST_APP_CONFIG_FILE=${DOCK_BUILD_ARG_DST_APP_CONFIG_FILE} WEB_LISTEN_PORT=${DOCK_BUILD_ARG_WEB_LISTEN_PORT} WEB_USER_ASSETS=${DOCK_BUILD_ARG_WEB_USER_ASSETS} STORAGE_TSDB_PATH=${DOCK_BUILD_ARG_STORAGE_TSDB_PATH} QUERY_LOOKBACK_DELTA=${DOCK_BUILD_ARG_QUERY_LOOKBACK_DELTA} QUERY_MAX_CONCURRENCY=${DOCK_BUILD_ARG_QUERY_MAX_CONCURRENCY} QUERY_TIMEOUT=${DOCK_BUILD_ARG_QUERY_TIMEOUT} STORAGE_TSDB_RETENTION=${DOCK_BUILD_ARG_STORAGE_TSDB_RETENTION} LOG_LEVEL=${DOCK_BUILD_ARG_LOG_LEVEL} AUTO_CONF_ENV=${AUTO_CONF_ENV} AUTO_CONF_BAIKO_TOKEN=${AUTO_CONF_BAIKO_TOKEN}

ADD     src/* ./
COPY    templates /templates/
# INSTALL PACKAGES
RUN     yum -y update && \
        yum -y install aws-cli jq python python-pip cron findutils bind-utils curl ca-certificates && \
        yum clean all && \
        curl -L https://storage.googleapis.com/kubernetes-release/release/${KUBE_LATEST_VERSION}/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl && \
        chmod +x /usr/local/bin/kubectl

EXPOSE 9090 9090



CMD	["sh","init.sh"]